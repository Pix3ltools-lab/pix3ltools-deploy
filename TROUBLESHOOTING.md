# Troubleshooting

Common issues and solutions for Pix3lTools Deploy.

## Containers & Docker

### Containers fail to start

- **Ports already in use**: Check if ports 3000, 3001, or 8080 are occupied:
  ```bash
  lsof -i :3000 -i :3001 -i :8080
  ```
  Stop conflicting services or change port mappings in `docker-compose.yml`.

- **Images not found**: Pull the latest images:
  ```bash
  docker compose pull
  ```

- **Docker daemon not running**:
  ```bash
  sudo systemctl start docker
  ```

### Containers in restart loop

Check container logs for error details:
```bash
docker compose logs <service-name>
docker compose logs --tail=50 pix3lboard
```

Common causes: missing environment variables, database not reachable.

### Old images cached locally

Force pull and recreate containers:
```bash
docker compose pull
docker compose up -d --force-recreate
```

## Database (sqld)

### Database not initialized

On first run, you must execute the init scripts. See the [Quick Start](README.md#quick-start) section.

Signs: login page shows but credentials are rejected, or app shows database errors on startup.

### Connection refused to sqld

The app containers may start before sqld is ready. Restart the app containers:
```bash
docker compose restart pix3lboard pix3lwiki
```

To prevent this, add `depends_on` with health checks in `docker-compose.yml`.

### Data lost after restart

- Make sure the `db-data` volume is defined in `docker-compose.yml`
- **Never** use `docker compose down -v` unless you intend to delete all data (`-v` removes volumes)
- Verify volumes exist:
  ```bash
  docker volume ls | grep pix3ltools
  ```

### Database corruption

Can happen after an unclean shutdown. Restore from backup:
```bash
docker compose down
docker compose cp ./backup-db/. sqld:/var/lib/sqld
docker compose up -d
```

## Authentication

### JWT_SECRET missing or invalid

- Ensure `.env` file exists (copy from `.env.example`)
- The secret must be at least 32 characters long
- Verify it's loaded:
  ```bash
  docker compose config | grep JWT_SECRET
  ```

### Login fails with correct credentials

- Confirm the database was initialized with the correct email/password
- Re-run the db-init scripts if needed
- Check that JWT_SECRET is the same across all services

### Token errors between services

Both pix3lboard and pix3lwiki must share the same `JWT_SECRET`. If they differ, tokens generated by one service will be rejected by the other.

## Networking

### Services cannot communicate with each other

- Verify all services are on the same Docker network:
  ```bash
  docker network inspect pix3ltools-deploy_default
  ```
- Use service names (not `localhost`) for inter-container communication

### Cannot access services from host

- Check port bindings: `docker compose ps`
- Verify firewall rules allow traffic on ports 3000, 3001, 8080
- If binding to `127.0.0.1`, services won't be accessible from other machines. Use `0.0.0.0` for external access.

### Reverse proxy issues (nginx/traefik)

- Ensure WebSocket connections are proxied correctly (needed for real-time features)
- Forward required headers: `Host`, `X-Real-IP`, `X-Forwarded-For`, `X-Forwarded-Proto`
- Set appropriate timeouts for long-running connections

## Storage & Volumes

### File uploads fail (pix3lboard)

- Verify the `blob-storage` volume is mounted correctly
- Check container permissions:
  ```bash
  docker compose exec pix3lboard ls -la /data/blob-storage
  ```

### Disk space full

- Remove old Docker images:
  ```bash
  docker image prune -a
  ```
- Check container logs size:
  ```bash
  docker system df
  ```
- Consider adding log rotation in `docker-compose.yml`:
  ```yaml
  logging:
    driver: json-file
    options:
      max-size: "10m"
      max-file: "3"
  ```

### Backup and restore

Backup:
```bash
docker compose cp sqld:/var/lib/sqld ./backup-db
docker compose cp pix3lboard:/data/blob-storage ./backup-blobs
```

Restore:
```bash
docker compose down
docker compose cp ./backup-db/. sqld:/var/lib/sqld
docker compose cp ./backup-blobs/. pix3lboard:/data/blob-storage
docker compose up -d
```

## CI/CD

### Build workflow fails

- Verify GHCR token has `write:packages` permission
- Check that the git ref (tag or branch) exists in the source repos
- Review workflow logs in **Actions** tab

### Images not published to registry

- Ensure the GitHub token is not expired
- Confirm the repository has correct package permissions under **Settings → Actions → General**

## General Tips

- Always check logs first: `docker compose logs -f`
- Verify environment: `docker compose config`
- Check resource usage: `docker stats`
- For a clean restart (preserving data): `docker compose down && docker compose up -d`
- For a full reset (deletes all data): `docker compose down -v && docker compose up -d`
